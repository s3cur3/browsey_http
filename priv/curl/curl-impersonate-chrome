#!/usr/bin/env bash

set -euo pipefail

# Find the directory of this script
dir=${0%/*}

os="$(uname -s)"
binary=""
raw_arch="$(uname -m)"

if [[ "$os" == "Linux" ]]; then
  case "$raw_arch" in
    x86_64 | amd64) arch="x86_64" ;;
    aarch64 | arm64) arch="aarch64" ;;
    armv7l | armv7 | armhf) arch="armv7l" ;;
    i386 | i686) arch="i386" ;;
    loongarch64) arch="loongarch64" ;;
    riscv64) arch="riscv64" ;;
    *) arch="$raw_arch" ;;
  esac

  binary="$dir/linux-$arch/curl-impersonate-chrome"

  # Backward compatibility for the old linux-x86_64 path.
  if [[ ! -x "$binary" && "$arch" == "x86_64" ]]; then
    binary="$dir/linux/curl-impersonate-chrome"
  fi
elif [[ "$os" == "Darwin" ]]; then
  case "$raw_arch" in
    x86_64 | amd64) arch="x86_64" ;;
    arm64 | aarch64) arch="arm64" ;;
    *) arch="$raw_arch" ;;
  esac

  binary="$dir/macos-$arch/curl-impersonate-chrome"
else
  echo "Unsupported OS for curl-impersonate: $os" >&2
  exit 1
fi

if [[ ! -x "$binary" ]]; then
  echo "No curl-impersonate binary available for $os/$arch" >&2
  exit 1
fi

"$binary" "$@"
